# GitLab CI/CD Pipeline for Robot Vacuum Cleaner (Julia + Rust)

variables:
  JULIA_VERSION: "1.10"
  RUST_VERSION: "stable"
  JULIA_DEPOT_PATH: "$CI_PROJECT_DIR/.cache/julia"
  CARGO_HOME: "$CI_PROJECT_DIR/.cache/cargo"
  CONTAINER_REGISTRY: $CI_REGISTRY
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE
  TRIVY_VERSION: "latest"
  SONAR_SCANNER_VERSION: "5.0"

# Define stages
stages:
  - prep
  - quality
  - security
  - test
  - build
  - scan
  - deploy
  - notify

# Cache configuration
cache:
  paths:
    - .cache/julia
    - .cache/cargo
    - target/

# Default settings
default:
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================================================
# PREPARATION STAGE
# ============================================================================

install:julia:
  stage: prep
  image: julia:${JULIA_VERSION}
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.instantiate()'
  artifacts:
    paths:
      - .cache/julia
    expire_in: 1 day
  cache:
    key: ${CI_COMMIT_REF_SLUG}-julia
    paths:
      - .cache/julia

# ============================================================================
# QUALITY STAGE
# ============================================================================

format:julia:
  stage: quality
  image: julia:${JULIA_VERSION}
  needs: ["install:julia"]
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.add("JuliaFormatter"); using JuliaFormatter; exit(format("src"; overwrite=false) ? 0 : 1)'
  allow_failure: true

lint:julia:
  stage: quality
  image: julia:${JULIA_VERSION}
  needs: ["install:julia"]
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.add("Lint"); using Lint; lintpkg("RobotVacuum")'
  allow_failure: true

format:rust:
  stage: quality
  image: rust:${RUST_VERSION}
  script:
    - cd src/rust
    - cargo fmt --all -- --check
  allow_failure: false

lint:clippy:
  stage: quality
  image: rust:${RUST_VERSION}
  script:
    - cd src/rust
    - rustup component add clippy
    - cargo clippy --all-targets --all-features -- -D warnings
  allow_failure: true

# ============================================================================
# SECURITY STAGE
# ============================================================================

security:trivy-fs:
  stage: security
  image:
    name: aquasec/trivy:${TRIVY_VERSION}
    entrypoint: [""]
  script:
    - trivy fs --exit-code 0 --no-progress --format json --output trivy-fs-report.json .
    - trivy fs --exit-code 1 --severity CRITICAL --no-progress .
  artifacts:
    reports:
      container_scanning: trivy-fs-report.json
    expire_in: 1 week
  allow_failure: true

security:gitleaks:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - gitleaks detect --source . --verbose --report-format json --report-path gitleaks-report.json
  artifacts:
    reports:
      secret_detection: gitleaks-report.json
    expire_in: 1 week
  allow_failure: true

security:cargo-audit:
  stage: security
  image: rust:${RUST_VERSION}
  script:
    - cargo install cargo-audit
    - cd src/rust
    - cargo audit --json > ../cargo-audit-report.json
  artifacts:
    paths:
      - cargo-audit-report.json
    expire_in: 1 week
  allow_failure: true

security:julia-audit:
  stage: security
  image: julia:${JULIA_VERSION}
  needs: ["install:julia"]
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.audit()'
  allow_failure: true

# ============================================================================
# TEST STAGE
# ============================================================================

test:julia:
  stage: test
  image: julia:${JULIA_VERSION}
  needs: ["install:julia", "lint:julia"]
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+%)/'
  artifacts:
    reports:
      junit: src/julia/RobotVacuum/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: src/julia/RobotVacuum/coverage.xml
    paths:
      - src/julia/RobotVacuum/coverage/
    expire_in: 1 week

test:julia:1.9:
  extends: test:julia
  image: julia:1.9
  parallel:
    matrix:
      - JULIA_VERSION: ["1.9"]

test:julia:1.10:
  extends: test:julia
  image: julia:1.10
  parallel:
    matrix:
      - JULIA_VERSION: ["1.10"]

test:rust:
  stage: test
  image: rust:${RUST_VERSION}
  needs: ["lint:clippy"]
  script:
    - cd src/rust
    - cargo test --verbose --all
  artifacts:
    reports:
      junit: src/rust/target/test-results.xml
    expire_in: 1 week

test:rust:coverage:
  stage: test
  image: rust:${RUST_VERSION}
  needs: ["lint:clippy"]
  script:
    - cd src/rust
    - cargo install cargo-tarpaulin
    - cargo tarpaulin --out Xml --output-dir coverage
  coverage: '/\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: src/rust/coverage/cobertura.xml
    paths:
      - src/rust/coverage/
    expire_in: 1 week
  allow_failure: true

# ============================================================================
# BUILD STAGE
# ============================================================================

build:julia:
  stage: build
  image: julia:${JULIA_VERSION}
  needs: ["test:julia"]
  script:
    - cd src/julia/RobotVacuum
    - julia --project=. -e 'using Pkg; Pkg.build()'
  artifacts:
    paths:
      - src/julia/RobotVacuum/
    expire_in: 1 day

build:rust:
  stage: build
  image: rust:${RUST_VERSION}
  needs: ["test:rust"]
  script:
    - cd src/rust
    - cargo build --release --verbose
  artifacts:
    paths:
      - src/rust/target/release/robot-vacuum
    expire_in: 1 week

build:container:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  needs: ["build:julia", "build:rust"]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context $CI_PROJECT_DIR
      --dockerfile $CI_PROJECT_DIR/docker/Containerfile
      --destination $CONTAINER_IMAGE:$CI_COMMIT_SHA
      --destination $CONTAINER_IMAGE:latest
      --cache=true
  only:
    - main
    - develop
    - /^claude\/.*/

# ============================================================================
# SCAN STAGE
# ============================================================================

scan:container:
  stage: scan
  image:
    name: aquasec/trivy:${TRIVY_VERSION}
    entrypoint: [""]
  needs: ["build:container"]
  script:
    - trivy image --exit-code 0 --no-progress --format json --output trivy-container-report.json $CONTAINER_IMAGE:$CI_COMMIT_SHA
    - trivy image --exit-code 1 --severity CRITICAL --no-progress $CONTAINER_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      container_scanning: trivy-container-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
    - /^claude\/.*/

scan:grype:
  stage: scan
  image:
    name: anchore/grype:latest
    entrypoint: [""]
  needs: ["build:container"]
  script:
    - grype $CONTAINER_IMAGE:$CI_COMMIT_SHA -o json > grype-report.json
    - grype $CONTAINER_IMAGE:$CI_COMMIT_SHA --fail-on critical
  artifacts:
    paths:
      - grype-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
    - /^claude\/.*/

sonarqube:
  stage: scan
  image:
    name: sonarsource/sonar-scanner-cli:${SONAR_SCANNER_VERSION}
    entrypoint: [""]
  needs: ["test:julia", "test:rust:coverage"]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
      -Dsonar.projectKey=robot-vacuum-cleaner
      -Dsonar.sources=src/
      -Dsonar.tests=tests/
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.login=${SONAR_TOKEN}
      -Dsonar.coverage.reportPaths=src/julia/RobotVacuum/coverage.xml,src/rust/coverage/cobertura.xml
  only:
    - main
    - develop
  allow_failure: true

# ============================================================================
# DEPLOY STAGE
# ============================================================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  needs: ["scan:container", "sonarqube"]
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    - echo "Container image: $CONTAINER_IMAGE:$CI_COMMIT_SHA"
    # Add actual deployment commands here
  environment:
    name: staging
    url: https://staging.robot-vacuum.example.com
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: alpine:latest
  needs: ["scan:container", "sonarqube"]
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    - echo "Container image: $CONTAINER_IMAGE:$CI_COMMIT_SHA"
    # Add actual deployment commands here
  environment:
    name: production
    url: https://robot-vacuum.example.com
  only:
    - main
  when: manual

# ============================================================================
# NOTIFY STAGE
# ============================================================================

notify:success:
  stage: notify
  image: alpine:latest
  needs: []
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Pipeline succeeded!"
    # Add notification commands (Slack, email, etc.)
  when: on_success
  only:
    - main
    - develop

notify:failure:
  stage: notify
  image: alpine:latest
  needs: []
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Pipeline failed!"
    # Add notification commands (Slack, email, etc.)
  when: on_failure
  only:
    - main
    - develop

# ============================================================================
# SPECIAL JOBS
# ============================================================================

pages:
  stage: deploy
  needs: ["test:julia", "test:rust:coverage"]
  script:
    - mkdir -p public
    - cp -r src/julia/RobotVacuum/coverage/ public/julia-coverage/
    - cp -r src/rust/coverage/ public/rust-coverage/
    - echo "Coverage reports published to GitLab Pages"
  artifacts:
    paths:
      - public
  only:
    - main

release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: ["build:julia", "build:rust", "build:container"]
  script:
    - echo "Creating release $CI_COMMIT_TAG"
  release:
    tag_name: '$CI_COMMIT_TAG'
    description: 'Release $CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Robot Vacuum Simulator (Rust)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src/rust/target/release/robot-vacuum'
  only:
    - tags
