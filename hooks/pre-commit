#!/bin/bash
# Pre-commit hook for Robot Vacuum Cleaner project
# Runs code quality checks before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "requirements.txt" ]; then
    echo -e "${RED}‚ùå Error: Must be run from project root${NC}"
    exit 1
fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check for Python
if ! command_exists python3; then
    echo -e "${RED}‚ùå Python 3 is required${NC}"
    exit 1
fi

# Get list of staged Python files
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo -e "${GREEN}‚úì No Python files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Checking ${#PYTHON_FILES[@]} Python files...${NC}"

# Install pre-commit tools if not available
if ! command_exists black; then
    echo "Installing code quality tools..."
    pip install -q black isort flake8 mypy bandit
fi

# 1. Black - Code formatting
echo "üé® Running Black..."
if black --check $PYTHON_FILES 2>&1 | grep -q "would reformat"; then
    echo -e "${YELLOW}‚ö† Code formatting issues found. Auto-formatting...${NC}"
    black $PYTHON_FILES
    git add $PYTHON_FILES
    echo -e "${GREEN}‚úì Code formatted${NC}"
else
    echo -e "${GREEN}‚úì Code formatting OK${NC}"
fi

# 2. isort - Import sorting
echo "üì¶ Running isort..."
if ! isort --check-only $PYTHON_FILES 2>&1; then
    echo -e "${YELLOW}‚ö† Import sorting issues found. Auto-fixing...${NC}"
    isort $PYTHON_FILES
    git add $PYTHON_FILES
    echo -e "${GREEN}‚úì Imports sorted${NC}"
else
    echo -e "${GREEN}‚úì Import sorting OK${NC}"
fi

# 3. Flake8 - Linting
echo "üîé Running Flake8..."
if ! flake8 $PYTHON_FILES --max-line-length=120 --extend-ignore=E203,W503; then
    echo -e "${RED}‚ùå Linting errors found${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Linting OK${NC}"

# 4. MyPy - Type checking (non-blocking)
echo "üîç Running MyPy..."
if command_exists mypy; then
    if ! mypy $PYTHON_FILES --ignore-missing-imports 2>&1; then
        echo -e "${YELLOW}‚ö† Type checking warnings (non-blocking)${NC}"
    else
        echo -e "${GREEN}‚úì Type checking OK${NC}"
    fi
fi

# 5. Bandit - Security linting
echo "üîí Running Bandit security scan..."
if ! bandit -r $PYTHON_FILES -ll 2>&1; then
    echo -e "${YELLOW}‚ö† Security warnings found (non-blocking)${NC}"
else
    echo -e "${GREEN}‚úì Security scan OK${NC}"
fi

# 6. Check for common issues
echo "üîß Checking for common issues..."

# Check for debug statements
if grep -n "import pdb\|pdb.set_trace()\|breakpoint()" $PYTHON_FILES; then
    echo -e "${RED}‚ùå Debug statements found${NC}"
    exit 1
fi

# Check for TODO/FIXME without issue reference
if grep -n "# TODO[^:]" $PYTHON_FILES; then
    echo -e "${YELLOW}‚ö† TODO without context found (consider adding issue reference)${NC}"
fi

# Check for print statements (should use logging)
if grep -n "print(" $PYTHON_FILES | grep -v "# print OK" | grep -v "__main__"; then
    echo -e "${YELLOW}‚ö† print() statements found (consider using logging)${NC}"
fi

# 7. Check for secrets
echo "üîê Checking for secrets..."
if command_exists gitleaks; then
    if ! gitleaks detect --no-git --verbose 2>&1; then
        echo -e "${RED}‚ùå Potential secrets found${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úì No secrets detected${NC}"
fi

# Check Rust files if any
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

if [ -n "$RUST_FILES" ]; then
    echo "ü¶Ä Checking Rust files..."

    if command_exists cargo; then
        cd src/rust 2>/dev/null || true

        # Run cargo fmt
        echo "üé® Running cargo fmt..."
        if ! cargo fmt -- --check; then
            echo -e "${YELLOW}‚ö† Rust formatting issues. Auto-formatting...${NC}"
            cargo fmt
            git add $RUST_FILES
        fi

        # Run cargo clippy
        echo "üîé Running cargo clippy..."
        if ! cargo clippy -- -D warnings; then
            echo -e "${RED}‚ùå Clippy errors found${NC}"
            exit 1
        fi

        cd ../..
        echo -e "${GREEN}‚úì Rust checks OK${NC}"
    fi
fi

# Check commit message format
COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Check for conventional commit format
    if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .+"; then
        echo -e "${YELLOW}‚ö† Commit message doesn't follow conventional commits format${NC}"
        echo "  Expected: type(scope): description"
        echo "  Examples: feat(api): add GraphQL endpoint"
        echo "            fix(robot): correct pathfinding bug"
    fi
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
