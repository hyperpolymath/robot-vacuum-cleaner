#!/bin/bash
# Post-merge hook for Robot Vacuum Cleaner project
# Runs after a successful git merge/pull

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸ”„ Post-merge hook running...${NC}"

# Function to check if file changed
file_changed() {
    git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q "^$1$"
}

# Check for dependency changes
DEPS_CHANGED=0

# Python dependencies
if file_changed "requirements.txt" || file_changed "requirements-dev.txt"; then
    echo -e "${YELLOW}ðŸ“¦ Python dependencies changed${NC}"
    echo "Run: pip install -r requirements.txt"
    DEPS_CHANGED=1
fi

# Rust dependencies
if file_changed "src/rust/Cargo.toml" || file_changed "src/rust/Cargo.lock"; then
    echo -e "${YELLOW}ðŸ¦€ Rust dependencies changed${NC}"
    echo "Run: cd src/rust && cargo build"
    DEPS_CHANGED=1
fi

# Container dependencies
if file_changed "docker/Containerfile" || file_changed "docker/compose.yaml"; then
    echo -e "${YELLOW}ðŸ³ Container configuration changed${NC}"
    echo "Run: podman-compose -f docker/compose.yaml build"
    DEPS_CHANGED=1
fi

# Database migrations (if any)
if [ -d "migrations" ]; then
    if git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q "^migrations/"; then
        echo -e "${YELLOW}ðŸ“Š Database migrations detected${NC}"
        echo "Run: alembic upgrade head"
        DEPS_CHANGED=1
    fi
fi

# Salt state changes
if file_changed "salt/minion.d/minion.conf" || git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q "^salt/states/"; then
    echo -e "${YELLOW}ðŸ§‚ Salt configuration changed${NC}"
    echo "Run: salt-call --local state.apply"
    DEPS_CHANGED=1
fi

# CI/CD configuration changes
if file_changed ".github/workflows/ci-cd.yml" || file_changed ".gitlab-ci.yml"; then
    echo -e "${YELLOW}ðŸ”§ CI/CD configuration changed${NC}"
    echo "Review the pipeline configuration"
    DEPS_CHANGED=1
fi

# Git hooks changes
if git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q "^hooks/"; then
    echo -e "${YELLOW}ðŸª Git hooks changed${NC}"
    echo "Run: ./scripts/install-hooks.sh"
    DEPS_CHANGED=1
fi

# Check for .env.example changes
if file_changed ".env.example"; then
    echo -e "${YELLOW}âš™ï¸ Environment variables template changed${NC}"
    echo "Update your .env file if needed"
    DEPS_CHANGED=1
fi

# Auto-update dependencies if requested
if [ "$DEPS_CHANGED" = "1" ]; then
    echo ""
    echo -e "${BLUE}Would you like to update dependencies automatically? (y/N)${NC}"

    # Only prompt if interactive
    if [ -t 0 ]; then
        read -r -n 1 response
        echo ""

        if [[ "$response" =~ ^[Yy]$ ]]; then
            # Update Python dependencies
            if file_changed "requirements.txt"; then
                echo "ðŸ“¦ Updating Python dependencies..."
                pip install -r requirements.txt --quiet
            fi

            # Update Rust dependencies
            if file_changed "src/rust/Cargo.toml"; then
                echo "ðŸ¦€ Updating Rust dependencies..."
                cd src/rust && cargo update --quiet && cd ../..
            fi

            echo -e "${GREEN}âœ“ Dependencies updated${NC}"
        fi
    else
        echo -e "${YELLOW}Run in interactive mode to auto-update${NC}"
    fi
fi

# Run quick health check
echo ""
echo -e "${BLUE}ðŸ¥ Running health check...${NC}"

# Check Python syntax
if command -v python3 >/dev/null 2>&1; then
    if python3 -m py_compile src/python/*.py 2>/dev/null; then
        echo -e "${GREEN}âœ“ Python syntax OK${NC}"
    else
        echo -e "${RED}âœ— Python syntax errors detected${NC}"
    fi
fi

# Check Rust compilation
if command -v cargo >/dev/null 2>&1 && [ -d "src/rust" ]; then
    if cargo check --manifest-path src/rust/Cargo.toml --quiet 2>/dev/null; then
        echo -e "${GREEN}âœ“ Rust code OK${NC}"
    else
        echo -e "${YELLOW}âš  Rust check warnings/errors${NC}"
    fi
fi

# Check for conflicts
if git ls-files -u | grep -q '^'; then
    echo -e "${RED}âš  Merge conflicts detected!${NC}"
    echo "Resolve conflicts before continuing"
    exit 1
fi

# Summary
echo ""
echo -e "${GREEN}âœ… Post-merge hook complete${NC}"

# Show summary of changes
CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD 2>/dev/null | wc -l)
echo -e "${BLUE}Files changed: $CHANGED_FILES${NC}"

# Show recent commits merged
echo ""
echo -e "${BLUE}Recent commits:${NC}"
git log --oneline HEAD@{1}..HEAD --no-merges | head -5

exit 0
